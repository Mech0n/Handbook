# 杂记

#### 0x0

复习计网的时候，记录一些零碎的知识。

#### 0x1 应用层

#### 0x2 运输层

1. 流量控制

   **确保任何一方都**不会过快地发送过量的分组而造成分组丢失。

   控制发送速率：当接收方来不及接收时，发送端降低发送速率。 

2. 

#### 0x3网络层

1. **路由表**组成

   对每组网络接口（interface），路由表至少会存有下面的信息：

   1. [网络ID](https://zh.wikipedia.org/w/index.php?title=网络ID&action=edit&redlink=1)（Network ID, Network number）：就是[目标地址](https://zh.wikipedia.org/w/index.php?title=目标地址&action=edit&redlink=1)的网络ID。
   2. [子网掩码](https://zh.wikipedia.org/wiki/子网掩码)（subnet mask）：用来判断IP所属网络
   3. 下一跳地址/接口（Next hop / interface）：就是数据在发送到目标地址的旅途中下一站的地址。其中interface指向next hop（即为下一个route）。一个[自治系统](https://zh.wikipedia.org/wiki/自治系统_(互联网))（AS, Autonomous system）中的route应该包含区域内所有的[子网](https://zh.wikipedia.org/wiki/子網路)，而[默认网关](https://zh.wikipedia.org/wiki/默认网关)（Network id: `0.0.0.0`, Netmask: `0.0.0.0`）指向自治系统的出口。

   根据应用和执行的不同，路由表可能含有如下附加信息：

   1. [花费](https://zh.wikipedia.org/w/index.php?title=花费&action=edit&redlink=1)（Cost）：就是数据发送过程中通过路径所需要的花费。
   2. 路由的服务质量
   3. 路由中需要过滤的出/入连接列表

   路由表也是一个网络安全的关键，像[单播可逆路径传输](https://zh.wikipedia.org/w/index.php?title=单播可逆路径传输&action=edit&redlink=1)（uRPF）[[3\]](https://zh.wikipedia.org/zh-sg/路由表#cite_note-3)就是一个安全路由表的例子。在这种具有多种变体的技术中，路由器也在路由表中查找数据包的[源地址](https://zh.wikipedia.org/w/index.php?title=源地址&action=edit&redlink=1)，如果源地址不正确，数据包就会显示出错或受到攻击。

#### 0x4 链路层

1. ARP表

   ![](https://i.loli.net/2019/11/27/EuQUXHAfBa6S2sL.png)

##### 0x5 一些常考的题型

1. 因特网采用层次路由的原因：

   - 规模：越来越多的路由器和主机使路由器的计算存储和转发工作变得越来越艰难。
   - 自制管理：管理者需要对自己区域内的路由器进行管理包括政策方面的因素。

2. AS是如何划分的：

   - AS是根据同一管理下的路由器集合划分的。

3. 各包含什么常用的选路协议，协议特点是什么？

   - 自治系统内路由协议：OSPF、RIP
   - OSPF：洪泛链路状态和最短路径Djstala算法
   - RIP：为信息在系统内的转发提供路由选择，采用DV算法
   - 自治系统间的路由协议：BGP
   - 获得每个自治系统间的可达信息：eBGP
   - 将可达信息在自治系统内部广播：iBGP

4. 下图OSPF的路由的作用分别是什么？

   - 区域内路由：为信息在系统内转发提供路由选择
   - 区域网关路由：为传递到区域外的分组提供路由选择
   - 网关路由器：为传递到自制系统外部的分组提供路由选择
   - 骨干路由器：为分组在区域间转发提供路由选择

5. 解释以太网CSMA/CD协议工作过程

   1. 网络层将数据报交给链路层适配器，适配器将数据报封装成帧后，放在适配器缓存中
   2. 适配器监听信道，若当前没有帧在信道中传输，则适配器将帧通过信道传输，若监听到信道忙，它等待到监听不到信号能量，然后开始传输该帧。
   3. 在传输过程中适配器检测到来自其他适配器内的信号能量，它就停止传输帧，并且传输一个48bit的阻塞信号。
   4. 在终止之后，适配器进入了一个指数后退段，在$m^{th}$碰撞后，适配器吃随机在${0,1,2,3,···,2^m-1}$中选择一个K值，适配器等待$K*512比特时间$并返回b步。
   5. 指数会推算法：
      - 首次碰撞：在{0,1}中选择k，延时$K*512比特时间$传输时间
      - 第二次碰撞后，从{0，1，2，3}中选择k
      - 10次碰撞后，从{0,1,2,···,1023}中选k。

6. 四种延时：

   - 传输时延
   - 传播时延
   - 处理时延
   - 排队时延

7. 如图，A节点如何利用ARP完成B节点的通信过程：

   ![](https://i.loli.net/2019/11/28/vMtrwSg2WYFIGBh.png)

   - A将B的IP地址与自己的子网掩码相与，发现A和B并不在一个子网，需要通过A的默认网关（111.111.111.0）进行转发。
   - 获取默认网关的MAC地址。节点A向他的适配器传递一个ARP查询包，将源MAC地址设置为自己的MAC，目的MAC地址为广播地址（FF:FF:FF:FF:FF:FF）,源IP地址为自己的IP（111.111.111.111）,目的IP为默认网关IP，适配器在链路层将ARP分组封装在数据帧中，并将数据帧发送至链路。默认网关收到数据帧之后，返回A节点一个包含自己MAC地址的ARP包。
   - A收到默认网关发送的ARP包之后更新自己ARP表，并将用于通信的数据报的源IP设为自己的IP，然后将目的IP设置为B节点的IP，将数据报发送至链路层封装，源MAC地址设置为自己的MAC地址，目的MAC地址设置为默认网关的MAC地址。发送给默认网关。
   - 子网1默认网关接收到数据帧，发现此包是向自己寻址的，将帧中的数据发送至网络层，查询转发表，得知数据报要通过子网2的接口（222.222.222.0），然后将数据报发送至链路层，将目的MAC地址设置为B节点的MAC地址，发送至子网B。
   - B节点接受数据。依次递交给上层。

8. 假设我在一个校园网内，校园网有一个教育网IPA，和三个外网IP分别是B、C、D组成，解释如何利用DHCP与NAT协议的工作原理解决学生上网问题的。

   - 首先，有题意可知，内网网关IP为A，由这个路由器利用DHCP将NAT和DHCP共同决定IP地址空间分配内网主机，假若内网中同学需要与外网B、C、D通信（或其他外网）。且已经设定好进程源端口，和目的端口。
   - 主机通过发送DHCP发现报文，源IP设置为0.0.0.0，目的IP设置为255.255.255.255，源端口号为67，目的端口号为68。发送广播包，假设某几个DHCP接收到请求报文，并分配IP，默认网关、子网掩码、租期发送广播包。主机接受到几个DHCP提供报文，主机选择其中一个，并广播DHCP请求报文，选中的DHCP服务器用DHCP ACK报文对DHCP请求报文进行响应，证实要求参数。
   - 主机得到本机IP之后，与外界通信，在数据报中填写目的端口号和源端口号，将数据报送给网络层封装本机IP和目的IP，再链路层封装，发送至NAT路由器。
   - NAT路由器随机选择没有用过的端口，和路由器IP替换数据报中的源端口号，和本机端口号，并将映射关系填写在NAT转发表中，封装向目标IP发送数据帧。

9. 访问[谷歌](www.google.com)问题

   - 根据上述先进行DHCP租用。获取本地IP
   - DNS查询：ARP获取网关MAC地址（上述题目已说明），随后将DNS查询报文封装，目的IP填入本地DNS服务器IP地址（DHCP服务器已告知），本机IP为源IP，目的端口号为53，协议为UDP，送交链路层，填入本机MAC地址，目的MAC地址填入网关MAC，发送至网关路由。网关路由得到数据帧，查询该目的IP，根据转发表（该转发表已有BGP、RIP、OSPF填写），选择适当输出端口发送该帧。最终DNS服务器得到该查询报文。查询本地缓存是否有[谷歌](www.google.com)的记录，如果有，则封装DNS回答报文，封装到UDP报文，反向发送至校园网中本机。如果没有，本地DNS服务器将查询报文发送至根DNS服务器，根DNS服务器发现com前缀，并向本地DNS服务器返回com的顶级域名解析服务器，本地DNS将com的顶级DNS服务器发送查询报文，com注意到google.com的前缀，并向本机DNS服务器返回其权威DNS服务器地址，本机DNS服务器向权威DNS服务器发送查询报文，返回最终的包含其IP的回答报文。
   - 连接：TCP三次握手，和HTTP报文。

